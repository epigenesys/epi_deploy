#!/usr/bin/env ruby

require 'slop'
require_relative '../lib/epi_deploy/command'

begin
  opts = Slop.parse strict: true do
  
    banner 'Usage: ed <command>'

    command 'release' do
      description 'Create a new release with optional deploy'

      on :d=, :deploy=, 'Deploy to specified environment(s)', argument: :optional, as: Array, delimiter: ':'

      run do |options, args|
        command = EpiDeploy::Command.new(options, args)
        command.release
      end
    end

    command 'deploy' do
      description 'Deploys an existing release'

      on :r=, :ref=, 'Git reference to deploy', argument: :optional
      
      run do |options, args|
        command = EpiDeploy::Command.new(options, args)
        command.deploy
      end
    end
    
    run do |options, args|
      fail "Valid commands are 'release' and 'deploy'."
    end
  
  end
rescue Slop::InvalidOptionError, Slop::InvalidArgumentError, RuntimeError => e
  fail e.message
end