#!/usr/bin/env ruby

require 'slop'
require 'highline'
require_relative '../lib/epi_deploy/release'

begin

  opts = Slop.parse strict: true do
  
    banner 'Usage: ed <command>'

    command 'release' do
      description 'Create a new release with optional deploy'

      on :d=, :deploy=, 'Deploy to specified environment(s)', argument: :optional

      run do |options, args|
        puts "options #{options.to_hash} and args: #{args.inspect}"
  
        release = EpiDeploy::Release.new options.to_hash
        release.create!
        puts "Release #{release.version} created with tag #{release.tag}"
      end
    end

    command 'deploy' do
      description 'Deploys an existing release'

      on :r=, :ref=, 'Git reference to deploy', argument: :optional

      run do |options, environments|
        puts "options #{options.to_hash} and environments: #{environments.inspect}"
      end 

    end
    
    
    run do |options, args|
      say "<%= color('Valid commands are release and deploy', RED) %>."
    end
  
  end
  
rescue Slop::InvalidOptionError => e
  puts e.message
end